function doGet(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Arabica Coffee Bookings');
    // نتجنب قراءة الصف الأول (العناوين) إذا كان موجودًا
    if (sheet.getLastRow() < 2) {
      return ContentService.createTextOutput(JSON.stringify([])).setMimeType(ContentService.MimeType.JSON);
    }
    // نقرأ فقط عمودي التاريخ والوقت لتحسين الأداء
    const data = sheet.getRange(2, 3, sheet.getLastRow() - 1, 2).getValues(); 
    
    const bookings = data.map(row => {
      const bookingDate = new Date(row[0]);
      // تحويل التاريخ إلى تنسيق YYYY-MM-DD ليتوافق مع الواجهة الأمامية
      const formattedDate = bookingDate.toISOString().split('T')[0];
      
      return {
        date: formattedDate, // التاريخ من العمود C
        time: row[1]         // الوقت من العمود D
      };
    });
    
    return ContentService.createTextOutput(JSON.stringify(bookings)).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({error: true, message: err.message})).setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Arabica Coffee Bookings'); // أو اسم الورقة التي تريد
    const data = JSON.parse(e.postData.contents);
    
    // التحقق من وجود البيانات الأساسية
    const requiredFields = ['fullName', 'phoneNumber', 'bookingDate', 'bookingTime', 'location'];
    const missingField = requiredFields.find(field => !data[field]);
    if (missingField) {
      throw new Error(`Missing required field: ${missingField}`);
    }

    // تحويل الأصناف الفرعية إلى نص واحد
    const items = Object.entries(data.items).map(([key, value]) => `${key}: ${value}`).join(", ");
    
    sheet.appendRow([
      data.fullName,
      data.phoneNumber,
      data.bookingDate,
      data.bookingTime,
      data.packageCups,
      data.totalPrice,
      data.location,
      data.notes,
      items,
      new Date()
    ]);
    
    return ContentService.createTextOutput(JSON.stringify({status: 'success'}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({status: 'error', message: err.message}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
